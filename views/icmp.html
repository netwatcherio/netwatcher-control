<div class="page-titles">
    <div class="row">
        <div class="col-lg-8 col-md-6 col-12 align-self-center">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0 d-flex align-items-center">
                    <li class="breadcrumb-item">
                        <a href="/home" class="link"><i class="ri-home-3-line fs-5"></i></a>
                    </li>
                    {{if .siteSelected}}
                    <li class="breadcrumb-item">
                        {{.siteName}}
                    </li>
                    {{end}}
                    <li class="breadcrumb-item active" aria-current="page">
                        {{.title}}
                    </li>
                </ol>
            </nav>
            <h1 class="mb-0 fw-bold">{{.title}} - icmp graphs</h1>
        </div>

        <div class="
                col-lg-4 col-md-6
                d-none d-md-flex
                align-items-center
                justify-content-end
              ">
            <a href="/icmp/{{.agentId}}" class="btn btn-info d-flex align-items-center ms-2">
                <i class="fa fa-globe"></i>
                view icmp
            </a>
            <a href="/iperf/{{.agentId}}" class="btn btn-info d-flex align-items-center ms-2">
                <i class="mdi mdi-lan-pending"></i>
                iperf
            </a>
            <a href="/iperf/{{.agentId}}" class="btn btn-info d-flex align-items-center ms-2">
                <i class="bi-file-bar-graph"></i>
                host stats
            </a>
        </div>

    </div>
</div>

<div class="container-fluid">
    <!-- ============================================================= -->
    <!-- Start Page Content -->
    <!-- ============================================================= -->
    <div class="row">
        <!-- column -->
        <div class="col-lg-12" id="icmpGraphs">
            <!--<div class="card" id="cardTARGET">
                <div class="border-bottom title-part-padding">
                    <h4 class="mb-0">ADDRESS</h4>
                </div>
                <div class="card-body">
                    <div>
                        <div class="chartjs-size-monitor"
                             style="position: absolute; inset: 0px; overflow: hidden; pointer-events: none; visibility: hidden; z-index: -1;">
                            <div class="chartjs-size-monitor-expand"
                                 style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;pointer-events:none;visibility:hidden;z-index:-1;">
                                <div style="position:absolute;width:1000000px;height:1000000px;left:0;top:0"></div>
                            </div>
                            <div class="chartjs-size-monitor-shrink"
                                 style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;pointer-events:none;visibility:hidden;z-index:-1;">
                                <div style="position:absolute;width:200%;height:200%;left:0; top:0">
                                </div>
                            </div>
                        </div>
                        <canvas class="chartjs-render-monitor" height="297" id="ADDRESS"
                                style="display: block; width: 595px; height: 297px;"
                                width="595"></canvas>
                    </div>
                </div>
            </div>-->
        </div>
        <!-- column -->
    </div>
    <!-- ============================================================= -->
    <!-- End PAge Content -->
    <!-- ============================================================= -->
    <script>
        let dataJson = JSON.parse('{{.icmpMetrics}}')
        let data = []

        for (let i = 0; i < dataJson.length; i++) {
            for (let i2 = 0; i2 < dataJson[i].data.length; i2++) {
                let item = dataJson[i].data[i2]

                if (data.filter(e => e.address === item.address).length > 0) {
                    console.log("1 multiple addresses match")
                }

                let index = data.findIndex(e => e.address == item.address);
                if (index == -1) {
                    let row = document.getElementById("icmpGraphs")
                    row.innerHTML += '<div class="card" id="card'+item.address.replaceAll(".", "")+'">' +
                        '                <div class="border-bottom title-part-padding">' +
                        '                    <h4 class="mb-0">'+item.address+'</h4>' +
                        '                </div>' +
                        '                <div class="card-body">' +
                        '                    <div>' +
                        '                        <div class="chartjs-size-monitor"' +
                        '                             style="position: absolute; inset: 0px; overflow: hidden; pointer-events: none; visibility: hidden; z-index: -1;">' +
                        '                            <div class="chartjs-size-monitor-expand"' +
                        '                                 style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;pointer-events:none;visibility:hidden;z-index:-1;">' +
                        '                                <div style="position:absolute;width:1000000px;height:1000000px;left:0;top:0"></div>' +
                        '                            </div>' +
                        '                            <div class="chartjs-size-monitor-shrink"' +
                        '                                 style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;pointer-events:none;visibility:hidden;z-index:-1;">' +
                        '                                <div style="position:absolute;width:200%;height:200%;left:0; top:0">' +
                        '                                </div>' +
                        '                            </div>' +
                        '                        </div>' +
                        '                        <canvas class="chartjs-render-monitor" height="297" id="graph'+item.address.replaceAll(".", "")+'"' +
                        '                                style="display: block; width: 595px; height: 297px;"' +
                        '                                width="595"></canvas>' +
                        '                    </div>' +
                        '                </div>' +
                        '            </div>'
                    
                    console.log("nothing found... creating...")
                    data.push({
                        "address": item.address,
                        "data": {"latAvg": [], "latMax": [], "latMin": [], "percentLoss": []}
                    })
                    index = data.length - 1
                }
                data[index].data.latMax.push({
                    x: item.result.stop_timestamp,
                    y: (item.result.metrics.latency_max / 1000) / 1000
                })

                data[index].data.latAvg.push({
                    x: item.result.stop_timestamp,
                    y: (item.result.metrics.latency_average / 1000) / 1000
                })

                data[index].data.latMin.push({
                    x: item.result.stop_timestamp,
                    y: (item.result.metrics.latency_min / 1000) / 1000
                })
                data[index].data.percentLoss.push({
                    x: item.result.stop_timestamp,
                    y: item.result.metrics.loss_percent
                })
            }
        }

        console.log(data)

        for (let i = 0; i < data.length; i++) {
            console.log(data[i].data)
            generateChart(data[i].address, data[i].data)
        }

        //Line Chart

        function generateChart(address, d) {
            let c = new Chart(document.getElementById('graph'+address.replaceAll(".", "")), {
                type: "line",
                data: {
                    //labels: timeStamps,
                    title: address,
                    datasets: [
                        {
                            data: d.latAvg,
                            label: "Average Latency",
                            borderColor: "#3e95cd",
                            fill: false,
                        },
                        {
                            data: d.latMax,
                            label: "Maximum Latency",
                            borderColor: "#a4d7f3",
                            fillColor: "#ffffff",
                            fill: true,
                        },
                        {
                            data: d.percentLoss,
                            label: "Loss %",
                            borderColor: "#ff2028",
                            fillColor: "#ff9999",
                            fill: true,
                        },
                        {
                            data: d.latMin,
                            label: "Minimum Latency",
                            borderColor: "#5fff20",
                            fillColor: "#c4ffb9",
                            fill: true,
                        },
                    ],
                },
                options: {
                    scales: {
                        y: [{
                            ticks: {
                                fontColor: "#b2b9bf",
                                fontSize: 12,
                            },
                        }],
                        x: [{
                            display: true,
                            type: 'time',
                            time: {
                                parser: 'YYYY-MM-DDTHH:mm:ss',
                                tooltipFormat: 'll HH:mm',
                                unit: 'day',
                                unitStepSize: 1,
                                displayFormats: {
                                    'day': 'MM/DD/YYYY'
                                }
                            },
                            ticks: {
                                autoSkip: true,
                                maxTicksLimit: 5,
                                fontColor: "#b2b9bf",
                                fontSize: 12,
                            },
                        }],
                    },
                },
            });
        }
    </script>
</div>